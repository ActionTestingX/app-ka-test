name: Develop Pull Request review bot

on:
  pull_request:
    types: [ opened, synchronize, edited, labeled ]
    branches:
      - main
      - develop


# Use concurrency to ensure that only one instance of this workflow is running at a time
concurrency:
  group: pr-lint-checker-dev-${{ github.sha }}
  cancel-in-progress: true

jobs:
#  pr-review:
#    uses: ActionTestingX/action-toolbox/.github/workflows/tool-review-pr.yaml@ka1
#    with:
#      python-version: 3.11
#    secrets:
#      SOURCE_KEY: ${{ secrets.SOURCE_KEY }}

  python-review:
    uses: ActionTestingX/action-toolbox/.github/workflows/tool-review-python.yaml@ka1
    with:
      python-version: 3.11
    secrets:
      CONDA_API_KEY: ${{ secrets.CONDA_API_KEY }}
      PIP_API_KEY: ${{ secrets.PIP_API_KEY }}

  pr-review-summary:
    name: Python Check Pull Request
    needs: [ pr-review, python-review ]
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install toml==0.10.2

      - name: Checkout PR
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Review all results and write a summary
        id: comment_body  # Set an ID for this step to reference its outputs
        shell: python
        run: |
          import os
          import base64
          
          def set_output(name, value, encode_it=False):
            if encode_it:
              value = base64.b64encode(value.encode('utf-8')).decode('utf-8')
            with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
                print(f'{name}={value}', file=fh)
          
          all_checks = []
          
          # PR
          pr_review_ok = '${{ needs.pr-review.outputs.pr_review_ok }}'
          pr_review_str = '${{ needs.pr-review.outputs.pr_review_str }}'
          all_checks.append(pr_review_ok == 'true')
          
          # Python
          python_review_ok = '${{ needs.python-review.outputs.python_review_ok }}'
          python_review_str = '${{ needs.python-review.outputs.python_review_str }}'
          all_checks.append(python_review_ok == 'true')
          
          # check if all_checks are true
          if all(all_checks):
            body = "ðŸ‘‹ Hi there! I have checked your PR and found no issues. Thanks for your contribution!\n"
            set_output('REVIEW_OK', 'true')
          else:
            body = "ðŸ‘‹ Hi there! I have checked your PR and found the following:\n\n"
            set_output('REVIEW_OK', 'false')
          
          body += pr_review_str
          body += python_review_str
          
          # Set the output
          set_output('body', body, True)
          
          print(os.environ['GITHUB_OUTPUT'])